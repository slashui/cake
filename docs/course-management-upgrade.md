# 课程管理系统升级文档

## 项目概述

本次升级将原有的单一课程管理系统扩展为支持多课程管理的完整平台。用户现在可以创建和管理多个独立的课程，每个课程都有自己的章节和课时结构，并且具备完整的用户权限控制系统。

## 主要功能改进

### 1. 多课程支持

**之前**: 系统只能管理一个固定的课程结构，课程信息存储在静态JSON文件中。

**现在**: 
- 支持创建和管理多个独立课程
- 每个课程都有独立的标题、描述、价格、分类等属性
- 课程状态管理：草稿(DRAFT)、已发布(PUBLISHED)、已归档(ARCHIVED)
- 完整的课程CRUD操作

### 2. 用户课程授权系统

**新增功能**:
- 用户可以被单独授权访问特定课程
- 支持基于角色的访问控制(FREE/PRIME/VIP)
- 课程级别、章节级别、课时级别的权限控制
- 灵活的授权管理界面

### 3. 全新的管理界面

**界面结构**:
- 三栏布局：课程列表 | 课程结构 | 内容编辑
- 标签式导航：课程管理 | 用户授权
- 模态框创建新课程
- 实时状态显示和权限标识

## 技术实现详情

### 数据库架构更新

#### 新增模型

1. **Course 模型增强**
```prisma
model Course {
    id          String    @id @default(cuid())
    title       String
    description String?
    thumbnail   String?   // 课程封面图片
    price       Float?    // 课程价格
    requiredRole RequiredRole @default(FREE) // 访问课程所需的角色等级
    status      CourseStatus @default(DRAFT) // 课程状态
    category    String?   // 课程分类
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
    chapters    Chapter[]
    userCourses UserCourse[] // 用户课程关联
}
```

2. **新增 CourseStatus 枚举**
```prisma
enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}
```

3. **新增 UserCourse 关联模型**
```prisma
model UserCourse {
    id        String   @id @default(cuid())
    userId    String
    courseId  String
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
    createdAt DateTime @default(now())
    
    @@unique([userId, courseId])
}
```

4. **User 模型更新**
```prisma
model User {
  // ... 原有字段
  userCourses    UserCourse[]  // 新增用户课程关联
}
```

### API端点设计

#### 1. 课程管理 API (`/api/courses`)

**GET** - 获取课程列表
- 查询参数：`courseId`（可选）
- 返回：课程列表或特定课程信息，包含完整的章节和课时结构

**POST** - 创建新课程
- 请求体：课程基本信息（title, description, price, requiredRole, status, category）
- 返回：创建的课程对象

**PUT** - 更新课程信息
- 请求体：课程ID和更新数据
- 返回：更新后的课程对象

**DELETE** - 删除课程
- 查询参数：`courseId`
- 功能：级联删除课程及其所有章节和课时

#### 2. 用户课程授权 API (`/api/user-courses`)

**GET** - 查询用户课程访问权限
- 查询参数：`userId`, `courseId`（可选）
- 返回：用户的课程访问权限或课程列表

**POST** - 授权用户访问课程
- 请求体：`userId`, `courseId`
- 返回：创建的授权记录

**DELETE** - 撤销用户课程访问权限
- 查询参数：`userId`, `courseId`
- 功能：删除用户对特定课程的访问权限

#### 3. 课程访问控制 API (`/api/course-access`)

**POST** - 检查用户对课程的访问权限
- 请求体：`userId`, `courseId`, `userRole`
- 返回：
  - 访问权限状态
  - 过滤后的可访问内容
  - 权限等级信息

**权限检查逻辑**：
1. 检查用户是否有直接的课程授权
2. 检查用户角色等级是否满足课程要求
3. 过滤章节和课时的可访问内容
4. 返回权限状态和可访问的内容结构

### 前端界面重构

#### 管理界面结构 (`/admin`)

1. **左侧面板 - 课程管理**
   - 标签切换：课程管理 / 用户授权
   - 创建课程按钮
   - 课程列表展示
   - 课程状态和权限标识

2. **中间面板 - 课程结构**
   - 显示选中课程的章节结构
   - 添加章节功能
   - 章节折叠/展开
   - 每个章节下显示课时列表
   - 添加/删除章节和课时的操作

3. **右侧面板 - 内容编辑**
   - 课程信息编辑（标题、描述、价格、状态、权限等）
   - 章节信息编辑（标题、描述、权限）
   - 课时详细编辑（包含原有的视频上传和MDX内容编辑功能）

#### 核心功能实现

1. **课程创建模态框**
   - 表单验证
   - 支持设置课程基本信息
   - 创建后自动选中新课程

2. **实时状态更新**
   - 所有编辑操作立即反映在界面上
   - 自动保存到数据库
   - 错误处理和用户反馈

3. **权限可视化**
   - 不同权限等级使用不同颜色标识
   - 状态标签显示课程和章节状态
   - 直观的权限设置界面

## 使用指南

### 管理员操作流程

1. **创建新课程**
   - 点击"创建课程"按钮
   - 填写课程基本信息
   - 设置访问权限和价格
   - 提交创建

2. **管理课程结构**
   - 在课程列表中选择要编辑的课程
   - 使用"添加章节"创建新章节
   - 在章节下添加具体的课时
   - 设置每个级别的访问权限

3. **编辑课程内容**
   - 选择具体的课程、章节或课时
   - 在右侧编辑面板修改相关信息
   - 上传视频和编辑MDX内容
   - 系统自动保存更改

4. **权限管理**
   - 在课程级别设置总体访问权限
   - 在章节级别设置更细粒度的权限
   - 在课时级别设置具体内容的访问权限
   - 使用用户授权功能为特定用户开放课程

### 权限系统说明

#### 角色等级
- **FREE**: 免费用户（等级1）
- **PRIME**: PRIME会员（等级2）  
- **VIP**: VIP会员（等级3）

#### 权限检查逻辑
1. **直接授权**: 用户被明确授权访问课程时，无视角色等级限制
2. **角色权限**: 用户角色等级 >= 内容要求等级时可以访问
3. **层级继承**: 章节权限不能低于课程权限，课时权限不能低于章节权限

#### 权限应用场景
- 免费课程：所有用户可访问
- 付费课程：只有对应等级会员或获得授权的用户可访问
- 预览模式：特定课时可设为预览，供免费用户体验

## 数据迁移

### 需要执行的迁移步骤

1. **数据库结构更新**
```bash
npx prisma generate
npx prisma db push
```

2. **现有数据迁移**（如果有现有课程数据）
   - 创建默认课程记录
   - 将现有章节关联到默认课程
   - 设置合适的权限等级

## 兼容性说明

### 保持兼容的功能
- MDX内容编辑功能完全保留
- 视频上传功能保持不变
- 课程访问API向后兼容
- 用户角色系统继续有效

### 新增的API端点
- 所有新API都是增量添加
- 不影响现有的API功能
- 现有前端组件可继续使用

## 安全考虑

### 权限验证
- 所有API端点都包含权限检查
- 用户只能访问被授权的内容
- 管理员操作需要特殊权限验证

### 数据保护
- 课程内容按权限过滤返回
- 敏感信息（如价格）只对管理员可见
- 用户数据和课程数据隔离存储

## 性能优化

### 数据库查询
- 使用Prisma的include优化关联查询
- 添加适当的索引支持快速查询
- 分页支持大量课程数据

### 前端性能
- 懒加载章节内容
- 缓存课程列表数据
- 优化大量DOM元素的渲染

## 后续扩展建议

### 功能增强
1. **课程统计**: 添加学习进度、完成率等统计功能
2. **批量操作**: 支持批量导入/导出课程内容
3. **模板系统**: 创建课程模板加快课程创建
4. **评论系统**: 为课程和课时添加评论功能

### 技术优化
1. **缓存策略**: 实现Redis缓存提升性能
2. **搜索功能**: 添加全文搜索支持
3. **国际化**: 扩展多语言支持到课程内容
4. **移动端**: 优化移动端管理界面

## 结论

本次升级成功将系统从单一课程管理扩展为完整的多课程平台，提供了灵活的权限控制和用户管理功能。新的架构为未来的功能扩展奠定了坚实的基础，同时保持了与现有系统的完全兼容性。

通过详细的权限系统和直观的管理界面，管理员可以轻松创建和管理复杂的课程结构，为不同层级的用户提供个性化的学习体验。