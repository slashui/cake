# 孤立课程清理脚本使用指南

## 概述

`cleanup-orphaned-courses-remote.js` 脚本用于检测和清理数据库中存在但文件系统中不存在的孤立课程记录。这个脚本特别适用于解决远程服务器上的课程目录与数据库不一致的问题。

## 问题背景

根据错误日志分析，系统中存在以下问题：
- 数据库中有课程ID `111` 和 `123` 的记录
- 但对应的课程目录在文件系统中不存在
- 导致 "Course metadata not found" 和 "Course directory not found" 错误

## 脚本功能

### 1. 检测功能
- 扫描数据库中的所有课程记录
- 检查每个课程ID对应的目录是否存在
- 统计有效课程和孤立课程的数量
- 显示每个孤立课程的详细信息（用户关联数、邀请码关联数）

### 2. 清理功能
- 安全删除孤立的课程记录
- 同时删除相关的用户课程关联
- 删除相关的邀请码课程关联
- 使用数据库事务确保数据一致性

## 使用方法

### 1. 仅检测（推荐先运行）

```bash
node cleanup-orphaned-courses-remote.js
```

这个命令会：
- 扫描所有课程记录
- 显示孤立课程列表
- 不会删除任何数据
- 提供删除确认的命令提示

### 2. 检测并删除

```bash
node cleanup-orphaned-courses-remote.js --confirm
# 或者
node cleanup-orphaned-courses-remote.js -y
```

这个命令会：
- 执行完整的检测和删除流程
- 永久删除孤立的课程记录
- 显示详细的删除结果

## 输出示例

### 检测阶段
```
🔍 正在检查数据库中的所有课程...
📊 数据库中共找到 15 个课程
✅ 有效课程: 1 - "React 基础教程"
✅ 有效课程: 2 - "Vue.js 进阶"
❌ 孤立课程: 111 - "测试课程1" (用户: 0, 邀请码: 0)
❌ 孤立课程: 123 - "测试课程2" (用户: 2, 邀请码: 1)

📈 统计结果:
   ✅ 有效课程: 13 个
   ❌ 孤立课程: 2 个
```

### 删除阶段
```
⚠️  发现 2 个孤立的课程记录:
   - 111: "测试课程1" (0 个用户, 0 个邀请码)
   - 123: "测试课程2" (2 个用户, 1 个邀请码)

🚨 警告: 删除这些课程将会:
   1. 永久删除课程记录
   2. 删除所有用户与这些课程的关联
   3. 删除所有邀请码与这些课程的关联
   4. 这个操作不可逆转!

🗑️  开始删除孤立的课程记录...
✅ 已删除课程 111: "测试课程1" (用户关联: 0, 邀请码关联: 0)
✅ 已删除课程 123: "测试课程2" (用户关联: 2, 邀请码关联: 1)

📊 删除完成:
   ✅ 成功删除: 2 个课程
   ❌ 删除失败: 0 个课程
```

## 安全特性

### 1. 双重确认机制
- 默认只检测，不删除
- 需要明确的 `--confirm` 参数才会执行删除
- 显示详细的影响范围警告

### 2. 数据库事务
- 使用 Prisma 事务确保操作的原子性
- 如果任何步骤失败，整个操作会回滚
- 避免数据不一致的情况

### 3. 详细日志
- 记录每个操作的详细信息
- 区分成功和失败的操作
- 提供清晰的统计结果

## 注意事项

### ⚠️ 重要警告
1. **不可逆操作**：删除操作无法撤销，请谨慎使用
2. **数据备份**：建议在运行删除操作前备份数据库
3. **生产环境**：在生产环境中使用前，请先在测试环境验证

### 📋 使用建议
1. **先检测**：总是先运行不带 `--confirm` 的命令查看结果
2. **验证结果**：仔细检查孤立课程列表，确认这些课程确实应该被删除
3. **分批处理**：如果孤立课程很多，可以考虑分批处理

## 相关文件

- `cleanup-orphaned-courses-remote.js` - 主脚本文件
- `check-course-111.js` - 单个课程检查脚本（已存在）
- `test-course.js` - 课程测试脚本（已存在）

## 故障排除

### 常见错误

1. **课程目录不存在**
   ```
   ❌ 课程目录不存在: /path/to/course/directory
   ```
   - 检查脚本中的 `COURSE_BASE_PATH` 路径是否正确
   - 确认课程目录结构是否符合预期

2. **数据库连接失败**
   - 检查 Prisma 配置
   - 确认数据库连接字符串正确

3. **权限问题**
   - 确保脚本有读取课程目录的权限
   - 确保有数据库写入权限（删除操作时）

### 调试模式

如果需要更详细的调试信息，可以设置环境变量：

```bash
DEBUG=* node cleanup-orphaned-courses-remote.js
```

## 扩展功能

脚本导出了以下函数，可以在其他脚本中使用：

```javascript
const { findOrphanedCourses, deleteOrphanedCourses, courseDirectoryExists } = require('./cleanup-orphaned-courses-remote.js');

// 检查特定课程目录是否存在
const exists = courseDirectoryExists('111');

// 获取孤立课程列表
const { orphanedCourses } = await findOrphanedCourses();
```